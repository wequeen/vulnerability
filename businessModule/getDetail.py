#!/usr/bin/env python
#-*- coding:utf-8 -*-
#@Time:2020/7/1416:49
#@Author:mery
#@File:getDetail.py

from businessModule.getList import get_links
from commonModule.get_html import get_html
import sqlite3
from util.queryDB import query

list_url = "https://www.cnvd.org.cn/flaw/list.htm?flag=true"
detail_url = "https://www.cnvd.org.cn"

def get_save_detail(keyword):

    links = []
    get_links(list_url, keyword, links)
    print(links)
    conn = sqlite3.connect("../bug.db")
    cur = conn.cursor()
    for link in links:
        url = detail_url + link
        result = get_html(url)
        title = result.select('body > div.mw.Main.clearfix > div.blkContainer > div.blkContainerPblk > div.blkContainerSblk > h1')
        title_text = ""
        if len(title) > 0:
            title_text = title[0].get_text().replace("\n","").replace("\r","").strip()
        cnvd_id = result.select('body > div.mw.Main.clearfix > div.blkContainer > div.blkContainerPblk > div.blkContainerSblk > div.blkContainerSblkCon.clearfix > div.tableDiv > table > tbody > tr:nth-child(1) > td:nth-child(2)')
        cnvd_id_text = ""
        if len(cnvd_id) > 0:
            cnvd_id_text = cnvd_id[0].get_text().replace(" ","").replace("\n","").replace("\r","").strip()
        grade = result.select('body > div.mw.Main.clearfix > div.blkContainer > div.blkContainerPblk > div.blkContainerSblk > div.blkContainerSblkCon.clearfix > div.tableDiv > table > tbody > tr:nth-child(3) > td.denle')
        grade_text = ""
        if len(grade) > 0:
            grade_text = grade[0].get_text().replace(" ","").replace("L","").replace("A","").replace("V","")\
                .replace("N","").replace(":","").replace("/","").replace("C","").replace("u","").replace("I","")\
                .replace("P","").replace("(","").replace(")","").replace("\n","").replace("\r","").strip()
        cve_id = result.select('body > div.mw.Main.clearfix > div.blkContainer > div.blkContainerPblk > div.blkContainerSblk > div.blkContainerSblkCon.clearfix > div.tableDiv > table > tbody > tr:nth-child(5) > td:nth-child(2) > a')
        cve_id_text = ""
        if len(cve_id) > 0:
            cve_id_text = cve_id[0].get_text().replace("\n","").replace("\r","").strip()
        description = result.select('body > div.mw.Main.clearfix > div.blkContainer > div.blkContainerPblk > div.blkContainerSblk > div.blkContainerSblkCon.clearfix > div.tableDiv > table > tbody > tr:nth-child(6) > td:nth-child(2)')
        description_text = ""
        if len(description) > 0:
            description_text = description[0].get_text().replace("\n","").replace("\r","").strip()
        vulType = result.select('body > div.mw.Main.clearfix > div.blkContainer > div.blkContainerPblk > div.blkContainerSblk > div.blkContainerSblkCon.clearfix > div.tableDiv > table > tbody > tr:nth-child(7) > td:nth-child(2)')
        vulType_text = ""
        if len(vulType) > 0:
            vulType_text = vulType[0].get_text().replace("\n","").replace("\r","").strip()
        solution = result.select('body > div.mw.Main.clearfix > div.blkContainer > div.blkContainerPblk > div.blkContainerSblk > div.blkContainerSblkCon.clearfix > div.tableDiv > table > tbody > tr:nth-child(9) > td:nth-child(2)')
        print(solution)
        solution_text = ""
        print(len(solution))
        if len(solution) > 0:
            solution_text = solution[0].get_text().replace("\n","").replace("\r","").strip()
            print(solution_text)
        annUrl = url
        nameInfo = keyword
        sql = "select * from business where cnnvdNo = '%s'"%(cnvd_id_text)
        queryResults = query(sql)
        if len(queryResults) < 1:
            sql = "insert into business (nameInfo,title,description ,grade,vulType ,cnvdNo ,annUrl,notice ,threatType ,cveNo) values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')" \
                  % (nameInfo,title_text, description_text, grade_text, vulType_text, cnvd_id_text, annUrl, solution_text,'',cve_id_text)
            print(sql)
            cur.execute(sql)
            print("已执行数据库插入")
            conn.commit()
    conn.close()