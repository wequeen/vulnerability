#!/usr/bin/env python
#-*- coding:utf-8 -*-
#@Time:2020/6/1119:25
#@Author:mery
#@File:getId.py

import time
from urllib.parse import urlencode

from blockChain.ask import askUrl
from util.queryDB import orign_count

baseurl = "https://bc.cnvd.org.cn/cnvdApi/vul/list?"

#从页面中提取漏洞的num号
def get_id(vulType,tableName):
    nums=[]
    #1.抓取共联漏洞页面数据
    response = get_page(1,vulType)
    result = response.get("result")
    count = result.get("count")
    print("当前 %s 漏洞数 %s条"%(vulType,count))
    sqlQuery = "select * from '%s'"%(tableName)
    orignCount = orign_count(sqlQuery)
    print("数据库中统计漏洞数 %s条"%(orignCount))
    addCount = count - orignCount
    if addCount > 0:
        pageCount = count // 10
        #print(pageCount)

        for page in range(1,pageCount + 1):
             response = get_page(page,vulType)
             result = response.get("result")
             data = result.get("data")
             for index in range(0,10):
                 num = data[index].get("num")
                 nums.append(num)
             #print(nums)
             time.sleep(2)
        response = get_page(pageCount + 1,vulType)
        result = response.get("result")
        data = result.get("data")
        for index in range(0,count % 10):
            num = data[index].get("num")
            nums.append(num)
        #print(nums)
    else:
        print("当前没有新增漏洞")
    return nums

#分页查询
def get_page(page,vulType):
    params = {
        'pageSize': '10',
        'pageNum': page,
        'vulType': vulType,
        'vulLevel':'',
        'period': '',
        'keyword': ''
    }
    url = baseurl + urlencode(params)
    print(url)
    #proxy_dict = userIp();
    result = askUrl(url,"https://bc.cnvd.org.cn/loopholeList")
    time.sleep(5)
    return result



