#!/usr/bin/env python
#-*- coding:utf-8 -*-
#@Time:2020/6/1611:24
#@Author:mery
#@File:saveInfo.py

import sqlite3

from blockChain.detail import get_detail
from blockChain.getId import get_id
from util.queryDB import query
from blockChain.diffrence import get_id_difference

def saveNum(nums,tableName):
    conn = sqlite3.connect("../bug.db")
    cur = conn.cursor()
    for num in nums:
        sqlQuery = "select * from '%s' where num is '%s'"%(tableName,num)
        cur.execute(sqlQuery)
        queryResults = cur.fetchone()
        if queryResults == None:
             sql = "insert into '%s' (num) values('%s')"%(tableName,num)
             cur.execute(sql)
             conn.commit()
        else:
            results = cur.fetchall()
            for row in results:
                print(row[0])
    conn.close()

def saveDetail(tableName):
    sql = "select num from '%s' where title is null"%(tableName)
    queryResults = query(sql)
    conn = sqlite3.connect("../bug.db")
    cur = conn.cursor()
    for row in queryResults:
        num = row[0]
        print(num)
        detailResponse = get_detail(num)
        result = detailResponse.get("result")
        data = result.get("data")
        print(data)
        title = data.get("title")
        description = data.get("description").replace("&lt;span style=&quot;font-size: large;&quot;&gt;","").replace("&lt;/span&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;","").replace("\n","")
        print(description)
        grade = data.get("grade")
        print(type(grade))
        if grade == "0":
            grade = "高危"
        elif grade == "1":
            grade = "中危"
        elif grade == "2":
            grade = "低危"
        else:
            print("漏洞等级有差异变化")
        vulType = data.get("vulType")
        vulNo = data.get("vulNo")
        solution = data.get("solution")
        if solution == None:
            print("无解决方案")
        else:
            solution = solution.replace("font-size: large;","").replace("target=","")\
                .replace("/span","").replace("a href=","").replace("style=","")\
                .replace("nbsp;","").replace("/&lt;","").replace("&lt;","").replace("&amp;","")\
                .replace("span","").replace("&quot;","").replace("&gt;","").replace("/p","")\
                .replace("br","").replace("\n","").replace("/a","")\
                .replace("color: rgb(77, 128, 191);","").replace("_blank","")\
                .replace(" ","").replace("phttp","http").replace("mdp","md")\
                .replace("orgp","org").replace("comp","com")
        print("1111111111111111111")
        print(solution)
        sql = "update '%s' set title = '%s', description = '%s', grade = '%s', vulType = '%s', vulNo = '%s', solution = '%s' where num = '%s'"%(tableName,title,description,grade,vulType,vulNo,solution,num)
        cur.execute(sql)
        conn.commit()
    conn.close()

'''def test():
    conn = sqlite3.connect("bug.db")
    cur = conn.cursor()
    num = "ccafc4682e4d7b2fd50e02a645bca823"
    sqlQuery = "select * from pubChain where num is '%s'"%(num)
    cur.execute(sqlQuery)
    queryResults = cur.fetchone()
    if queryResults == None:
        print("123")
    conn.close()'''

def save(vulType,tableName):
    nums = get_id(vulType,tableName)
    saveNum(nums, tableName)
    saveDetail(tableName)

def save_difference(vulType,tableName):
    nums = get_id_difference(vulType)
    saveNum(nums,tableName)
    saveDetail(tableName)
